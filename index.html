<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Vanka Escapes | åœ¨çº¿å‘ç¥¨ç”Ÿæˆå™¨</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- jsPDF & html2canvasï¼ˆCDNï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --ink:#111; --muted:#6b7280; --line:#e5e7eb; --primary:#111;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg); color:var(--ink); line-height:1.45;
    }
    header{padding:24px}
    .wrap{max-width:1100px;margin:0 auto;padding:0 16px 64px}
    .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:24px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
    h1{font-size:20px;margin:0 0 6px}
    h2{font-size:16px;margin:0 0 10px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:14px; background:#fff;
    }
    textarea{min-height:84px; resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px}
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer;font-weight:600;
    }
    .btn.primary{background:var(--primary);color:#fff;border-color:#000}
    .btn.ghost{background:#fff}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--line);font-size:14px;text-align:left;vertical-align:top}
    .table th{color:#374151;font-weight:700;background:#fafafa}
    .right{text-align:right}
    .total{font-weight:800}
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:6px 10px;border:1px solid var(--line);border-radius:999px}
    .sticky-footer{position:sticky;bottom:0;background:transparent;padding:16px 0}
    .footbar{display:flex;gap:10px;flex-wrap:wrap}
    .logo-preview{display:flex;align-items:center;gap:12px}
    .logo-preview img{max-height:46px;border-radius:8px;border:1px solid var(--line);background:#fff}
    /* å‘ç¥¨é¢„è§ˆçº¸å¼ æ ·å¼ï¼ˆA4 å°ºå¯¸è¿‘ä¼¼ï¼Œä¾›å±å¹•é¢„è§ˆï¼‰ */
    #invoice{
      background:#fff;color:#111; width:794px; /* ~A4 @96dpi */
      margin:0 auto; border:1px solid var(--line); border-radius:12px; padding:28px;
    }
    .inv-head{display:flex;justify-content:space-between;align-items:flex-start;gap:16px}
    .inv-meta{display:grid;gap:6px; font-size:13px}
    .brand{font-size:18px;font-weight:800}
    .divider{height:1px;background:var(--line);margin:16px 0}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    .bank{font-size:13px; white-space:pre-wrap; border:1px dashed var(--line); border-radius:10px; padding:10px}
    .notes{white-space:pre-wrap; font-size:13px}
    .badge{font-size:11px;color:#111;background:#f3f4f6;border:1px solid var(--line);display:inline-block;padding:4px 8px;border-radius:999px}
    .sum{margin-left:auto;max-width:360px}
    .sum table{width:100%}
    .sum td{padding:6px 0;font-size:14px}
    .sum td:last-child{text-align:right}
    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
      #invoice{width:100%}
    }
  </style>
</head>
<body>
  <header class="wrap">
    <div class="toolbar">
      <button class="btn primary" id="savePdf">ğŸ“„ ä¸‹è½½ PDF</button>
      <button class="btn ghost" id="saveData">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
      <button class="btn ghost" id="loadData">â¤´ï¸ è¯»å–è®¾ç½®</button>
      <button class="btn ghost" id="clearData">ğŸ§¹ æ¸…ç©ºè®¾ç½®</button>
      <span class="chip">æç¤ºï¼šæ‰€æœ‰å†…å®¹ä»…ä¿å­˜åœ¨ä½ çš„æµè§ˆå™¨ï¼ˆlocalStorageï¼‰</span>
    </div>
  </header>

  <div class="wrap grid">
    <!-- å·¦ä¾§ï¼šè¡¨å• -->
    <section class="card">
      <h1>å‘ç¥¨ä¿¡æ¯</h1>
      <div class="row">
        <div>
          <label>å‘ç¥¨å·</label>
          <input id="invNo" placeholder="ä¾‹å¦‚ VE-2025-001" />
        </div>
        <div>
          <label>å‘ç¥¨æ—¥æœŸ</label>
          <input id="invDate" type="date" />
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>å¸ç§</label>
          <select id="currency">
            <option value="USD">USD</option>
            <option value="SGD">SGD</option>
            <option value="CNY">CNY</option>
            <option value="EUR">EUR</option>
            <option value="JPY">JPY</option>
          </select>
        </div>
        <div>
          <label>ç¨ç‡ï¼ˆ%ï¼‰</label>
          <input id="taxRate" type="number" step="0.01" value="0" />
        </div>
      </div>

      <div class="divider"></div>

      <h2>å…¬å¸ä¿¡æ¯ï¼ˆå¼€ç¥¨æ–¹ï¼‰</h2>
      <div class="logo-preview">
        <div>
          <label>ä¸Šä¼ å…¬å¸ Logoï¼ˆPNG/JPGï¼‰</label>
          <input id="logoFile" type="file" accept="image/*" />
          <div class="muted">æˆ–ç²˜è´´ Logo å¤–é“¾ï¼š</div>
          <input id="logoUrl" placeholder="https://example.com/logo.png" />
        </div>
        <img id="logoImg" alt="Logo é¢„è§ˆ" />
      </div>
      <label>å…¬å¸åç§°</label>
      <input id="fromName" value="Vanka Escapes Pte. Ltd." />
      <label>å…¬å¸åœ°å€</label>
      <textarea id="fromAddr" placeholder="Address, City, Country, Postal Code"></textarea>
      <label>å…¬å¸è”ç³»æ–¹å¼</label>
      <input id="fromContact" placeholder="Phone / Email / Website" />

      <div class="divider"></div>

      <h2>å®¢æˆ·ä¿¡æ¯ï¼ˆæ”¶æ¬¾æ–¹ï¼‰</h2>
      <label>å®¢æˆ·åç§°</label>
      <input id="toName" placeholder="Client / Company" />
      <label>å®¢æˆ·åœ°å€</label>
      <textarea id="toAddr"></textarea>
      <label>å®¢æˆ·è”ç³»äººä¸é‚®ç®±</label>
      <input id="toContact" placeholder="Name / Email / Phone" />

      <div class="divider"></div>

      <h2>é¡¹ç›®è¡Œ</h2>
      <table class="table" id="itemsTable">
        <thead>
          <tr>
            <th style="width:42%">é¡¹ç›® / æè¿°</th>
            <th style="width:18%">å•ä»·</th>
            <th style="width:16%">æ•°é‡</th>
            <th style="width:18%">å°è®¡</th>
            <th style="width:6%"></th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
      <div style="margin-top:12px">
        <button class="btn" id="addItem">â• æ·»åŠ ä¸€è¡Œ</button>
      </div>

      <div class="divider"></div>

      <h2>æ”¶æ¬¾è´¦æˆ·ï¼ˆæ˜¾ç¤ºåœ¨å‘ç¥¨åº•éƒ¨ï¼‰</h2>
      <textarea id="bank" placeholder="Bank Name: XXX Bank
Account Name: Vanka Escapes Pte. Ltd.
Account No / IBAN: XXXXX
SWIFT / BIC: XXXXX
Bank Address: XXXXX"></textarea>

      <label>æ¡æ¬¾ä¸å¤‡æ³¨ï¼ˆå¯å¤šè¡Œï¼‰</label>
      <textarea id="notes" placeholder="Payment due within 7 days. Thank you for your business."></textarea>
    </section>

    <!-- å³ä¾§ï¼šå³æ—¶é¢„è§ˆï¼ˆPDF å°†ä»¥æ­¤ä¸ºæ¨¡æ¿æ¸²æŸ“ï¼‰ -->
    <section class="card">
      <h1>é¢„è§ˆï¼ˆA4ï¼‰</h1>
      <div id="invoice" aria-label="invoice-preview">
        <div class="inv-head">
          <div class="inv-meta">
            <span class="brand">INVOICE å‘ç¥¨</span>
            <span id="pInvNo" class="badge">ç¼–å·ï¼šâ€”</span>
            <span id="pInvDate" class="badge">æ—¥æœŸï¼šâ€”</span>
          </div>
          <div>
            <img id="pLogo" alt="Logo" style="max-height:60px; border-radius:8px; border:1px solid var(--line)" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="two">
          <div>
            <strong>Fromï¼ˆå¼€ç¥¨æ–¹ï¼‰</strong><br/>
            <div id="pFromName"></div>
            <div id="pFromAddr" class="muted"></div>
            <div id="pFromContact" class="muted"></div>
          </div>
          <div>
            <strong>Bill Toï¼ˆå®¢æˆ·ï¼‰</strong><br/>
            <div id="pToName"></div>
            <div id="pToAddr" class="muted"></div>
            <div id="pToContact" class="muted"></div>
          </div>
        </div>

        <div class="divider"></div>

        <table class="table" id="pItems">
          <thead>
            <tr>
              <th>é¡¹ç›® / æè¿°</th>
              <th class="right">å•ä»·</th>
              <th class="right">æ•°é‡</th>
              <th class="right">å°è®¡</th>
            </tr>
          </thead>
          <tbody id="pItemsBody"></tbody>
        </table>

        <div class="two" style="margin-top:10px; align-items:flex-start">
          <div>
            <div><strong>å¤‡æ³¨ / Notes</strong></div>
            <div id="pNotes" class="notes"></div>
          </div>
          <div class="sum">
            <table>
              <tr><td>å¸ç§</td><td id="pCurrency">â€”</td></tr>
              <tr><td>å°è®¡ Subtotal</td><td id="pSubtotal">â€”</td></tr>
              <tr><td>ç¨ç‡ Tax</td><td id="pTaxRate">â€”</td></tr>
              <tr class="total"><td>åˆè®¡ Total</td><td id="pTotal">â€”</td></tr>
            </table>
          </div>
        </div>

        <div class="divider"></div>

        <div>
          <strong>æ”¶æ¬¾è´¦æˆ· Bank Details</strong>
          <div id="pBank" class="bank"></div>
        </div>

        <div style="margin-top:18px;font-size:12px;color:#9ca3af">
          æ­¤å‘ç¥¨ç”± Vanka Escapes åœ¨çº¿å‘ç¥¨ç”Ÿæˆå™¨åˆ›å»º
        </div>
      </div>

      <div class="sticky-footer">
        <div class="footbar">
          <span class="muted">é¢„è§ˆå³æ‰€è§å³æ‰€å¾—ï¼›ä¸‹è½½çš„ PDF å¸ƒå±€ä¸æ­¤ä¸€è‡´ã€‚</span>
        </div>
      </div>
    </section>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);

  const state = {
    logoDataUrl: "",
    rows: []
  };

  // Utilities
  function money(n){ 
    const cur = $("#currency").value || "USD";
    const f = Number.isFinite(n) ? n : 0;
    return new Intl.NumberFormat('zh-CN', { minimumFractionDigits:2, maximumFractionDigits:2 }).format(f) + " " + cur;
  }
  function parseNum(v){ const n = parseFloat((v||"").toString().replace(/,/g,"")); return isNaN(n)?0:n; }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function uid(){ return Math.random().toString(36).slice(2,9); }

  // DOM refs for preview
  const p = {
    invNo: $("#pInvNo"),
    invDate: $("#pInvDate"),
    logo: $("#pLogo"),
    fromName: $("#pFromName"),
    fromAddr: $("#pFromAddr"),
    fromContact: $("#pFromContact"),
    toName: $("#pToName"),
    toAddr: $("#pToAddr"),
    toContact: $("#pToContact"),
    itemsBody: $("#pItemsBody"),
    currency: $("#pCurrency"),
    subtotal: $("#pSubtotal"),
    taxRate: $("#pTaxRate"),
    total: $("#pTotal"),
    bank: $("#pBank"),
    notes: $("#pNotes"),
  };

  // Form refs
  const f = {
    invNo: $("#invNo"),
    invDate: $("#invDate"),
    currency: $("#currency"),
    taxRate: $("#taxRate"),
    logoFile: $("#logoFile"),
    logoUrl: $("#logoUrl"),
    logoImg: $("#logoImg"),
    fromName: $("#fromName"),
    fromAddr: $("#fromAddr"),
    fromContact: $("#fromContact"),
    toName: $("#toName"),
    toAddr: $("#toAddr"),
    toContact: $("#toContact"),
    itemsBody: $("#itemsBody"),
    addItem: $("#addItem"),
    bank: $("#bank"),
    notes: $("#notes"),
    savePdf: $("#savePdf"),
    saveData: $("#saveData"),
    loadData: $("#loadData"),
    clearData: $("#clearData"),
  };

  // Init defaults
  function initDefaults(){
    if(!f.invNo.value) f.invNo.value = `VE-${new Date().getFullYear()}-${String(Math.floor(Math.random()*999)+1).padStart(3,"0")}`;
    if(!f.invDate.value) f.invDate.value = todayISO();
    if(!f.fromAddr.value) f.fromAddr.value = "68 Circular Road, #02-01, Singapore 049422";
    if(!f.fromContact.value) f.fromContact.value = "Tel: +65 xxxx xxxx Â· Email: info@vankaescapes.com Â· www.vankaescapes.com";
    if(!f.bank.value) f.bank.value = `Bank Name: DBS Bank Ltd
Account Name: Vanka Escapes Pte. Ltd.
Account No / IBAN: 123-456789-0
SWIFT/BIC: DBSSSGSG
Bank Address: 12 Marina Boulevard, Singapore`;
    addRow(); // at least one
    refresh();
  }

  // Item rows
  function addRow(data={}){
    const id = data.id || uid();
    const tr = document.createElement("tr");
    tr.dataset.id = id;
    tr.innerHTML = `
      <td>
        <input placeholder="é¡¹ç›®åç§° / æè¿°"
               value="${data.desc||''}" />
      </td>
      <td class="right">
        <input type="number" step="0.01" placeholder="å•ä»·" value="${data.unit||''}" />
      </td>
      <td class="right">
        <input type="number" step="0.01" placeholder="æ•°é‡" value="${data.qty||''}" />
      </td>
      <td class="right muted subtotal">â€”</td>
      <td class="right">
        <button class="btn" title="åˆ é™¤è¯¥è¡Œ">âœ–</button>
      </td>
    `;
    f.itemsBody.appendChild(tr);
    tr.addEventListener("input", refresh);
    tr.querySelector("button").addEventListener("click", ()=>{
      tr.remove(); refresh();
    });
    return tr;
  }

  // Calc & preview render
  function refresh(){
    // Sync preview meta
    p.invNo.textContent = "ç¼–å·ï¼š" + (f.invNo.value || "â€”");
    p.invDate.textContent = "æ—¥æœŸï¼š" + (f.invDate.value || "â€”");
    p.fromName.textContent = f.fromName.value || "";
    p.fromAddr.textContent = f.fromAddr.value || "";
    p.fromContact.textContent = f.fromContact.value || "";
    p.toName.textContent = f.toName.value || "";
    p.toAddr.textContent = f.toAddr.value || "";
    p.toContact.textContent = f.toContact.value || "";
    p.currency.textContent = f.currency.value || "â€”";
    p.bank.textContent = f.bank.value || "";
    p.notes.textContent = f.notes.value || "";

    // Logo
    if(state.logoDataUrl){
      p.logo.src = state.logoDataUrl;
      f.logoImg.src = state.logoDataUrl;
    }else if(f.logoUrl.value){
      p.logo.src = f.logoUrl.value;
      f.logoImg.src = f.logoUrl.value;
    }else{
      p.logo.removeAttribute("src");
      f.logoImg.removeAttribute("src");
    }

    // Items
    p.itemsBody.innerHTML = "";
    let subtotal = 0;
    [...f.itemsBody.querySelectorAll("tr")].forEach(tr=>{
      const [descEl, unitEl, qtyEl] = tr.querySelectorAll("input");
      const desc = descEl.value.trim();
      const unit = parseNum(unitEl.value);
      const qty = parseNum(qtyEl.value);
      const line = unit * qty;
      subtotal += line;

      tr.querySelector(".subtotal").textContent = money(line);

      const pr = document.createElement("tr");
      pr.innerHTML = `
        <td>${desc||'â€”'}</td>
        <td class="right">${money(unit)}</td>
        <td class="right">${qty || 0}</td>
        <td class="right">${money(line)}</td>
      `;
      p.itemsBody.appendChild(pr);
    });

    const taxRate = parseNum(f.taxRate.value);
    const taxAmount = subtotal * (taxRate/100);
    const total = subtotal + taxAmount;

    p.subtotal.textContent = money(subtotal);
    p.taxRate.textContent = `${taxRate.toFixed(2)}% (${money(taxAmount)})`;
    p.total.textContent = money(total);
  }

  // File logo upload -> dataURL
  f.logoFile.addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => { state.logoDataUrl = reader.result; refresh(); };
    reader.readAsDataURL(file);
  });
  f.logoUrl.addEventListener("input", ()=>{ state.logoDataUrl = ""; refresh(); });

  // Add item row
  f.addItem.addEventListener("click", ()=> addRow());

  // Bind inputs to refresh
  ["invNo","invDate","currency","taxRate","fromName","fromAddr","fromContact","toName","toAddr","toContact","bank","notes"]
    .forEach(id => f[id].addEventListener("input", refresh));

  // Save / Load settings (localStorage)
  function snapshot(){
    const rows = [...f.itemsBody.querySelectorAll("tr")].map(tr=>{
      const [d,u,q] = tr.querySelectorAll("input");
      return {desc:d.value, unit:u.value, qty:q.value};
    });
    return {
      invNo:f.invNo.value, invDate:f.invDate.value, currency:f.currency.value, taxRate:f.taxRate.value,
      logoDataUrl: state.logoDataUrl, logoUrl: f.logoUrl.value,
      fromName:f.fromName.value, fromAddr:f.fromAddr.value, fromContact:f.fromContact.value,
      toName:f.toName.value, toAddr:f.toAddr.value, toContact:f.toContact.value,
      bank:f.bank.value, notes:f.notes.value,
      rows
    };
  }
  function hydrate(data){
    f.invNo.value = data.invNo||"";
    f.invDate.value = data.invDate||"";
    f.currency.value = data.currency||"USD";
    f.taxRate.value = data.taxRate||"0";
    state.logoDataUrl = data.logoDataUrl||"";
    f.logoUrl.value = data.logoUrl||"";
    f.fromName.value = data.fromName||"";
    f.fromAddr.value = data.fromAddr||"";
    f.fromContact.value = data.fromContact||"";
    f.toName.value = data.toName||"";
    f.toAddr.value = data.toAddr||"";
    f.toContact.value = data.toContact||"";
    f.bank.value = data.bank||"";
    f.notes.value = data.notes||"";

    f.itemsBody.innerHTML = "";
    (data.rows||[]).forEach(r => addRow(r));
    if((data.rows||[]).length===0) addRow();
    refresh();
  }
  f.saveData.addEventListener("click", ()=>{
    localStorage.setItem("vanka_invoice_v1", JSON.stringify(snapshot()));
    alert("å·²ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°ã€‚");
  });
  f.loadData.addEventListener("click", ()=>{
    const raw = localStorage.getItem("vanka_invoice_v1");
    if(!raw){ alert("æ²¡æœ‰ä¿å­˜çš„æ•°æ®"); return; }
    hydrate(JSON.parse(raw));
  });
  f.clearData.addEventListener("click", ()=>{
    if(confirm("ç¡®å®šæ¸…ç©ºæœ¬åœ°ä¿å­˜çš„è®¾ç½®å—ï¼Ÿ")){ localStorage.removeItem("vanka_invoice_v1"); alert("å·²æ¸…ç©ºã€‚"); }
  });

  // Export PDF (A4)
  f.savePdf.addEventListener("click", async ()=>{
    // æŠŠé¢„è§ˆåŒºåŸŸæ¸²æŸ“ä¸ºå›¾ç‰‡ï¼Œå†å¡å…¥ PDF
    const node = document.getElementById("invoice");
    // ä¸´æ—¶æå‡åˆ†è¾¨ç‡
    const scale = 2;
    const canvas = await html2canvas(node, { scale, backgroundColor:"#ffffff" });
    const imgData = canvas.toDataURL("image/png");

    const { jsPDF } = window.jspdf;
    // A4 çºµå‘: 210 x 297 mm -> jsPDF å•ä½ mm
    const pdf = new jsPDF({ unit:"mm", format:"a4", orientation:"portrait" });

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    // å›¾ç‰‡ä»¥é¡µé¢å®½åº¦ä¸ºå‡†ï¼ŒæŒ‰æ¯”ä¾‹ç¼©æ”¾
    const imgWidth = pageWidth - 20; // å·¦å³è¾¹è· 10mm
    const imgHeight = canvas.height * imgWidth / canvas.width;

    let y = 10;
    pdf.addImage(imgData, "PNG", 10, y, imgWidth, imgHeight, undefined, "FAST");

    // å¦‚æœé«˜åº¦è¶…è¿‡ä¸€é¡µï¼Œè¿›è¡Œåˆ†é¡µ
    let remaining = imgHeight - (pageHeight - 20);
    while (remaining > 0) {
      pdf.addPage();
      y = 10;
      pdf.addImage(imgData, "PNG", 10, y - (imgHeight - remaining), imgWidth, imgHeight, undefined, "FAST");
      remaining -= (pageHeight - 20);
    }

    const filename = (f.invNo.value || "invoice") + ".pdf";
    pdf.save(filename);
  });

  // Kickoff
  initDefaults();
})();
</script>
</body>
</html>
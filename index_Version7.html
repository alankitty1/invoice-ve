<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>在线发票生成器</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #fafbfc;}
    .container { display: flex; gap: 40px; }
    .form-area, .preview-area { padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #eee;}
    .form-area { width: 410px;}
    .preview-area { flex: 1;}
    h2 { margin-top: 0; font-size: 22px;}
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px;}
    th, td { border: 1px solid #e1e4e8; padding: 8px; vertical-align: top;}
    button { margin: 3px 0;}
    #attachmentList li { margin-bottom: 5px;}
    #attachment-preview img { height: 80px; margin-right: 8px; margin-bottom: 8px;}
    .actions { margin-top: 22px;}
    .desc {
      font-size: 16px;
      min-height: 80px;
      resize: vertical;
      width: 98%;
      box-sizing: border-box;
    }
    input[type="text"], input[type="number"], input[type="date"] {
      width: 85%;
      font-size: 15px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <h1>在线发票生成器</h1>
  <div class="container">
    <div class="form-area">
      <h2>发票信息</h2>
      <label>发票编号：<input id="invoiceNum" type="text" value="INV20250909"></label><br>
      <label>日期：<input id="invoiceDate" type="date" value=""></label><br>
      <label>客户名称：<input id="customerName" type="text" value="测试客户"></label><br>
      <label>币种：<input id="currency" type="text" value="¥"></label><br>
      <label>税率（%）：<input id="taxRate" type="number" min="0" max="100" value="0"></label><br>
      <h2>项目</h2>
      <table>
        <thead>
          <tr>
            <th style="width:42%">描述</th>
            <th style="width:18%">单价</th>
            <th style="width:16%">数量</th>
            <th style="width:18%">小计</th>
            <th style="width:6%"></th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
      <button onclick="addRow()">添加项目</button>
      <h2>附件（支持多选）</h2>
      <input type="file" id="attachments" multiple />
      <ul id="attachmentList"></ul>
      <div id="attachment-preview"></div>
      <div class="actions">
        <button onclick="downloadPDF()">下载发票 PDF（含图片附件）</button>
      </div>
    </div>
    <div class="preview-area" id="previewArea">
      <!-- 发票预览会自动生成 -->
    </div>
  </div>
  <script>
    // 自动填充今天日期
    document.getElementById('invoiceDate').value = new Date().toISOString().slice(0,10);

    // 默认项目行
    function addRow(desc='', price='', qty='') {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><textarea class="desc" rows="5" style="width:98%;">${desc}</textarea></td>
        <td><input class="price" type="number" min="0" value="${price}"></td>
        <td><input class="qty" type="number" min="1" value="${qty}"></td>
        <td class="subtotal">0</td>
        <td><button onclick="this.closest('tr').remove(); refresh()">删除</button></td>
      `;
      document.getElementById('itemsBody').appendChild(tr);
      [...tr.querySelectorAll('input,textarea')].forEach(inp => inp.oninput = refresh);
      refresh();
    }
    addRow('产品设计费', '2000', '1');
    addRow('开发服务费', '5000', '2');

    // 附件管理
    let attachments = [];
    document.getElementById('attachments').addEventListener('change', function(e){
      attachments = [];
      document.getElementById('attachmentList').innerHTML = '';
      document.getElementById('attachment-preview').innerHTML = '';
      [...this.files].forEach(file => {
        const li = document.createElement('li');
        li.textContent = file.name;
        document.getElementById('attachmentList').appendChild(li);

        if(file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(ev){
            attachments.push({type:'image', name:file.name, dataURL:ev.target.result});
            const img = document.createElement('img');
            img.src = ev.target.result;
            document.getElementById('attachment-preview').appendChild(img);
            refresh();
          };
          reader.readAsDataURL(file);
        } else {
          attachments.push({type:'other', name:file.name});
          refresh();
        }
      });
    });

    function refresh() {
      let html = `<h2>发票预览</h2>
        <p>编号：${val('invoiceNum')}<br>
        日期：${val('invoiceDate')}<br>
        客户：${val('customerName')}</p>
        <table><thead><tr><th>描述</th><th>单价</th><th>数量</th><th>小计</th></tr></thead><tbody>`;
      let total = 0;
      document.querySelectorAll('#itemsBody tr').forEach(tr => {
        const desc = tr.querySelector('.desc').value;
        const price = parseFloat(tr.querySelector('.price').value) || 0;
        const qty = parseInt(tr.querySelector('.qty').value) || 0;
        const subtotal = price * qty;
        tr.querySelector('.subtotal').textContent = subtotal.toFixed(2);
        total += subtotal;
        html += `<tr><td>${desc.replace(/\n/g,'<br>')}</td><td>${price.toFixed(2)}</td><td>${qty}</td><td>${subtotal.toFixed(2)}</td></tr>`;
      });
      html += `</tbody></table>`;
      const tax = total * (parseFloat(val('taxRate'))||0)/100;
      html += `<p>合计：${val('currency')}${total.toFixed(2)}<br>税费：${val('currency')}${tax.toFixed(2)}<br><b>总计：${val('currency')}${(total+tax).toFixed(2)}</b></p>`;
      // 附件预览
      if(attachments.length) {
        html += `<h3>附件</h3><ul>`;
        attachments.forEach(att => {
          if(att.type === 'image') {
            html += `<li>图片：${att.name}</li>`;
          } else {
            html += `<li>文件：${att.name}</li>`;
          }
        });
        html += `</ul>`;
      }
      document.getElementById('previewArea').innerHTML = html;
    }
    function val(id){ return document.getElementById(id).value||''; }
    document.querySelectorAll('input').forEach(inp => inp.oninput = refresh);

    // PDF 生成
    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:'pt', format:'a4' });
      const preview = document.getElementById('previewArea');
      const canvas = await html2canvas(preview, { scale:2 });
      const imgData = canvas.toDataURL('image/png');
      pdf.addImage(imgData, 'PNG', 24, 24, 548, 0);

      // 附件图片页
      let imgCount = 0;
      for(const att of attachments) {
        if(att.type === 'image') {
          if(imgCount === 0) {
            pdf.addPage();
            pdf.setFontSize(16);
            pdf.text('附件图片', 40, 40);
            y = 64;
          }
          pdf.addImage(att.dataURL, 'PNG', 40, y, 120, 90);
          pdf.text(att.name, 170, y+50);
          y += 100;
          imgCount++;
        }
      }
      pdf.save("invoice.pdf");
    }
  </script>
</body>
</html>